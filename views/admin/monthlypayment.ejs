<!-- monthlypayment.ejs -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Monthly Payment</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Icons" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="/css/admin/monthlypayment.css">
</head>
<body>
   <div class="header">

    <!-- Notifications -->
    <div class="notifications">
        <span class="material-symbols-outlined" id="notifIcon">notifications</span>
        <div class="notif-count" id="notifCount">3</div>
    </div>

    
    <!-- User Account -->
    <div class="user-account">
        <div class="user-profile">
            <img src="/image/profile-img.png" alt="profile-img">
            <div class="user-detail">
                <h3>Aileen Mercado</h3>
                <span>Landlord</span>
            </div>
        </div>
    </div>
</div>

<!-- Notification Popup -->
<div class="notif-popup" id="notifPopup">
    <div class="notif-popup-header">
        <h4>Notifications</h4>
        <span id="closeNotif">&times;</span>
    </div>
    <div class="notif-popup-body">
        <p class="notif-item">New payment received from Juan Dela Cruz</p>
        <p class="notif-item">Room 101 is now available</p>
        <p class="notif-item">Tenant Maria updated profile</p>
    </div>
    <div class="notif-popup-footer">
        <p class="view-all">View all notifications</p>
    </div>
</div>


    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="/image/logo.png" alt="logo">
            <h3>BH Payment Monitoring </h3>
        </div>
        <ul class="sidebar-links">
            <!-- <h4>Main Menu</h4> -->
            <div class="menu-separator"></div>
            <li><a href="Admindashboard"><span class="material-symbols-outlined">Dashboard</span>Dashboard</a></li>
            <li><a href="usermanagement"><span class="material-symbols-outlined">Manage_Accounts</span>Tenants</a></li>
            <li><a href="room"><span class="material-symbols-outlined">room_preferences</span>Room</a></li>
            <li><a href="payment"><span class="material-symbols-outlined">payments</span>Deposit</a></li>
            <li><a href="monthlypayment"><span class="material-symbols-outlined">money</span>Monthly Payment</a></li>
          
        <li class="messages">
    <a href="message" class="messages-link">
        <span class="material-symbols-outlined" id="messageIcon">chat</span>
        Messages
        <span class="msg-count" id="msgCount">5</span>
    </a>
</li>
            <li><a href="/login"><span class="material-symbols-outlined">Logout</span>Logout</a></li>
        </ul>
        
    </aside>


    <main class="main-content">
    <div class="top">
        <div class="sticky-header"><h4>Monthly Payment</h4></div>   

        
        <div class="add-search">
           <button class="btn-add" id="openModalBtn">Add Payment</button>
            <div class="search-container">
                <span class="material-icons search-icon">search</span>
                <input type="text" id="searchInput" placeholder="Search">
            </div>

        </div>



  <table class="payment-table">
    <thead>
        <tr>
            <th>Tenant Name</th>
            <th>Monthly Due Date</th>
            <th>Monthly Rent</th>
            <th>Date Paid</th>
            <th>Amount Paid</th>
            <th>Remaining Balance</th>
            <th>Action</th>

        </tr>
    </thead>


<tbody id="paymentTableBody">
    <% 
    let totalAmountPaid = 0;
    let totalRemainingBalance = 0;

    if (monthlyPayments && monthlyPayments.length > 0) { 
        monthlyPayments.forEach(payment => { 
            totalAmountPaid += Number(payment.amount_paid);
            totalRemainingBalance += Number(payment.remaining_balance);
    %>
        <tr>
            <td><%= payment.tenant_name %></td>
            <td><%= new Date(payment.monthly_due_date).toLocaleDateString() %></td>
            <td><%= payment.monthly_rent %></td>
            <td><%= payment.date_paid ? new Date(payment.date_paid).toLocaleDateString() : '-' %></td>
            <td><%= payment.amount_paid %></td>
            <td><%= payment.remaining_balance %></td>
            <td>
                <% if(payment.remaining_balance > 0) { %>
                    <form action="/admin/markMonthlyPaid/<%= payment.id %>" method="POST" class="markPaidForm">
                        <button type="submit" class="markPaidBtn">Mark as Paid</button>
                    </form>
                <% } else { %>
                    <button class="markPaidBtn paid" disabled>Paid</button>
                <% } %>
            </td>
        </tr>
    <% }) %>

    <!-- Totals row -->
    <tr>
        <td colspan="4" style="text-align:right;"><strong>Total:</strong></td>
        <td><strong><%= totalAmountPaid.toFixed(2) %></strong></td>
        <td><strong><%= totalRemainingBalance.toFixed(2) %></strong></td>
        <td></td>
    </tr>

    <% } else { %>
        <tr>
            <td colspan="7">No records found</td>
        </tr>
    <% } %>
</tbody>


</table>

<br>

<div class="pagination">
    <button id="prevPage">Prev</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Next</button>
</div>


    </div>

    <!-- Add Payment Modal -->
<div class="modal" id="addModal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h4>Add Monthly Payment</h4>

        <form action="/admin/addMonthlyPayment" method="POST">

            <!-- Tenant Dropdown -->
            <select name="tenant_id" id="tenantSelect" required>
                <option value="">Select Tenant</option>
                <% tenants.forEach(t => { %>
                    <option 
                        value="<%= t.Users_ID %>" 
                        data-duedate="<%= t.Monthly_DueDate %>"
                        data-rent="<%= t.Monthly_Rent %>"
                        data-name="<%= t.FirstName + ' ' + t.LastName %>"
                    >
                        <%= t.FirstName %> <%= t.LastName %>
                    </option>
                <% }) %>
            </select>

            <!-- Auto-filled -->
            <input type="text" id="tenantName" name="tenant_name" readonly>
            <input type="date" id="monthlyDueDate" name="monthly_due_date" readonly>
            <input type="number" id="monthlyRent" name="monthly_rent" readonly>

            <!-- User input -->
            <input type="number" id="amountPaid" name="amount_paid" step="0.01" placeholder="Amount Paid">

            <!-- Auto-calculated -->
            <input type="number" id="remainingBalance" name="remaining_balance" readonly>

            <button type="submit">Save Payment</button>
        </form>

       
    </div>
</div>


</main>

<script>
const searchInput = document.getElementById("searchInput");

searchInput.addEventListener("input", function() {
    const filter = this.value.toLowerCase();
    rows.forEach(row => {
        const tenantName = row.querySelector("td:first-child").innerText.toLowerCase();
        if (tenantName.includes(filter)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});
</script>

<script>
const rowsPerPage = 5;
const tableBody = document.getElementById("paymentTableBody");
const rows = Array.from(tableBody.querySelectorAll("tr"));
const pageInfo = document.getElementById("pageInfo");
const prevBtn = document.getElementById("prevPage");
const nextBtn = document.getElementById("nextPage");

let currentPage = 1;
const totalPages = Math.ceil(rows.length / rowsPerPage);

function showPage(page) {
    // Hide all rows first
    rows.forEach(row => row.style.display = "none");

    // Calculate start and end index
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    // Show only the current page rows
    rows.slice(start, end).forEach(row => row.style.display = "");

    // Update page info
    pageInfo.innerText = `Page ${page} of ${totalPages}`;

    // Disable buttons if needed
    prevBtn.disabled = page === 1;
    nextBtn.disabled = page === totalPages;
}

// Button events
prevBtn.addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        showPage(currentPage);
    }
});
nextBtn.addEventListener("click", () => {
    if (currentPage < totalPages) {
        currentPage++;
        showPage(currentPage);
    }
});

// Initialize first page
showPage(currentPage);
</script>

<script>
document.querySelectorAll(".markPaidForm").forEach(form => {
    form.addEventListener("submit", function(e){
        e.preventDefault();

        const button = this.querySelector(".markPaidBtn");

        // Confirmation
        if(!confirm("Are you sure you want to mark this payment as PAID?")) return;

        // Update UI immediately
        const row = button.closest("tr");
        row.querySelector("td:nth-child(6)").innerText = "0"; // remaining balance
        button.disabled = true;
        button.innerText = "Paid";
        button.classList.add("paid");

        // Submit form to backend
        fetch(this.action, { method: 'POST' })
            .then(response => response.text())
            .catch(err => console.error(err));
    });
});
</script>


<script>
    const tenantSelect = document.getElementById("tenantSelect");
    const tenantName = document.getElementById("tenantName");
    const monthlyDueDate = document.getElementById("monthlyDueDate");
    const monthlyRent = document.getElementById("monthlyRent");
    const amountPaid = document.getElementById("amountPaid");
    const remainingBalance = document.getElementById("remainingBalance");
    const markAsPaidBtn = document.getElementById("markAsPaidBtn");

    // When selecting tenant
    tenantSelect.addEventListener("change", function () {
        const option = this.options[this.selectedIndex];

        tenantName.value = option.dataset.name;
        monthlyDueDate.value = option.dataset.duedate;
        monthlyRent.value = option.dataset.rent;

        // Reset fields
        amountPaid.value = "";
        remainingBalance.value = option.dataset.rent;
    });

    // Calculate remaining balance
    amountPaid.addEventListener("input", function () {
        remainingBalance.value = (monthlyRent.value - amountPaid.value).toFixed(2);
    });


</script>

<script>
    const modal = document.getElementById("addModal");
    const openModalBtn = document.getElementById("openModalBtn");
    const closeModalBtn = document.getElementById("closeModal");

    openModalBtn.onclick = () => modal.style.display = "block";
    closeModalBtn.onclick = () => modal.style.display = "none";
    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }
</script>



</body>

</html>
       